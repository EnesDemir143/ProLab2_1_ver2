<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra Modern Yol Çizici</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(195, 207, 226, 0.8));
      transition: background 0.5s ease;
      color: #1e3a8a;
    }

    body.night-mode {
      background: linear-gradient(135deg, #1a2634, #2e3b55);
      color: #d4d4d8;
    }

    #map {
      height: 80vh;
      width: 70vw;
      float: right;
      border-radius: 1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.5s ease;
    }

    #map:hover {
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
    }

    .controls-container {
      width: 28vw;
      float: left;
      padding: 1rem;
      overflow-y: auto;
      max-height: 80vh;
    }
    .night-mode .controls-container .bg-white {
      background: #3a3a3a;
      color: #e0e0e0;
    }

    .coords-display {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(29, 78, 216, 0.8));
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      font-family: 'Poppins', sans-serif;
      color: #fff;
      transition: all 0.4s ease;
      backdrop-filter: blur(12px);
      z-index: 100;
      font-size: 0.9rem;
    }

    .input-field {
      background: linear-gradient(145deg, rgba(219, 234, 254, 0.9), rgba(191, 219, 254, 0.9));
      box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.05), inset -3px -3px 6px rgba(255, 255, 255, 0.9);
      border: 2px solid #3b82f6;
      border-radius: 1rem;
      transition: all 0.5s ease;
      color: #1e40af;
    }

    .night-mode .input-field {
      background: linear-gradient(145deg, #2e3b55, #3b4a6b);
      color: #d4d4d8;
      border: 2px solid #8b5cf6;
    }

    .input-field:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3);
      transform: scale(1.02);
    }

    .btn-draw, .toggle-btn, .marker-btn {
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      border-radius: 1.5rem;
      transition: all 0.5s ease;
    }

    .night-mode .btn-draw, .night-mode .toggle-btn, .night-mode .marker-btn {
      background: transparent;
      border: 2px solid #8b5cf6;
      color: #d4d4d8;
    }

    .btn-draw:hover, .toggle-btn:hover, .marker-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 16px rgba(139, 92, 246, 0.4);
    }

    .night-mode .btn-draw:hover, .night-mode .toggle-btn:hover, .night-mode .marker-btn:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    .navbar {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(29, 78, 216, 0.9));
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      border-radius: 0 0 1rem 1rem;
    }

    .night-mode .navbar {
      background: linear-gradient(135deg, #1a2634, #2e3b55);
    }

    .nav-link {
      color: #fff;
      transition: all 0.4s ease;
    }

    .nav-link:hover {
      color: #93c5fd;
      transform: translateY(-3px);
    }

    .popup {
      position: fixed;
      top: 50%;
      right: 2rem;
      transform: translateY(-50%) scale(0.9);
      background: linear-gradient(135deg, rgba(219, 234, 254, 0.95), rgba(191, 219, 254, 0.9));
      border-radius: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      max-width: 400px;
      width: 25vw;
      z-index: 200;
      opacity: 0;
      transition: all 0.4s ease;
      border: 2px solid #3b82f6;
      backdrop-filter: blur(10px);
      color: #1e40af;
    }

    .popup.show {
      opacity: 1;
      transform: translateY(-50%) scale(1);
    }

    .night-mode .popup {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(55, 65, 81, 0.9));
      border: 2px solid #8b5cf6;
      color: #d4d4d8;
    }

    .night-mode .controls-container h2,
    .night-mode .controls-container label {
      color: #d8d4d4;
    }

    .popup h3 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      text-align: center;
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      -webkit-background-clip: text;
      color: transparent;
    }

    .night-mode .popup h3 {
      background: linear-gradient(45deg, #8b5cf6, #facc15);
      -webkit-background-clip: text;
      color: transparent;
    }

    .route-card {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .night-mode .route-card {
      background: rgba(55, 65, 81, 0.8);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .route-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .popup button {
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 1.5rem;
      margin-top: 1rem;
      width: 100%;
      transition: all 0.3s ease;
    }

    .night-mode .popup button {
      background: transparent;
      border: 2px solid #8b5cf6;
      color: #d4d4d8;
    }

    .popup button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(139, 92, 246, 0.4);
    }

    .night-mode .popup button:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 100;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    .overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      color: #fff;
      cursor: pointer;
      transition: all 0.4s ease;
      z-index: 100;
      font-size: 1.5rem;
    }

    .night-mode .mode-toggle {
      background: transparent;
      border: 2px solid #8b5cf6;
      color: #d4d4d8;
    }

    .mode-toggle:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 16px rgba(139, 92, 246, 0.4);
    }

    .night-mode .mode-toggle:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    .dynamic-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
    }

    .dynamic-section.show {
      max-height: 200px;
      margin-top: 0.5rem;
    }

    .marker-btn img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 8px;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 2rem;
    }

    .content-wrapper {
      display: flex;
      flex: 1;
      gap: 2rem;
      margin-top: 2rem;
    }

    .controls-container {
      width: 25vw;
      min-width: 300px;
      max-width: 400px;
      padding: 1.5rem;
    }

    #map-container {
      flex: 1;
      position: relative;
      min-height: 80vh;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 30;
    }

    .mode-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 40;
    }

    .coords-display {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      z-index: 10;
    }

    .popup {
      position: fixed;
      top: 50%;
      right: 2rem;
      transform: translateY(-50%);
      width: 25vw;
      max-width: 400px;
    }

    @media (max-width: 1024px) {
      .content-wrapper {
        flex-direction: column;
      }

      .controls-container {
        width: 100%;
        max-width: none;
      }

      #map-container {
        height: 60vh;
      }

      .popup {
        width: 80%;
        right: 50%;
        transform: translate(50%, -50%);
      }
    }

    #routeInfo {
      max-height: 500px;
      overflow-y: auto;
    }

    .transport-type {
      cursor: pointer;
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: rgba(59, 130, 246, 0.1);
      margin-bottom: 0.5rem;
    }

    .night-mode .transport-type {
      background: rgba(139, 92, 246, 0.1);
    }

    .transport-type:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .night-mode .transport-type:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    .route-list {
      display: none;
      margin-left: 1rem;
    }

    .route-list.show {
      display: block;
    }

    .popup {
      position: fixed;
      top: 50%;
      right: 2rem;
      transform: translateY(-50%) scale(0.9);
      background: linear-gradient(135deg, rgba(219, 234, 254, 0.95), rgba(191, 219, 254, 0.9));
      border-radius: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      max-width: 400px;
      width: 25vw;
      z-index: 200;
      opacity: 0;
      transition: all 0.4s ease;
      border: 2px solid #3b82f6;
      backdrop-filter: blur(10px);
      color: #1e40af;
    }

    .popup.show {
      opacity: 1;
      transform: translateY(-50%) scale(1);
    }

    .night-mode .popup {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(55, 65, 81, 0.9));
      border: 2px solid #8b5cf6;
      color: #d4d4d8;
    }

    /* Updated overlay to be transparent and allow interaction */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent; /* No darkening effect */
      z-index: 100;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none; /* Allows interaction with background */
    }

    .overlay.show {
      opacity: 1;
      pointer-events: none; /* Still allows background interaction */
    }

    .route-card.disabled {
      background: rgba(150, 150, 150, 0.8); /* Gray background */
      color: #666; /* Darker gray text */
      pointer-events: none; /* Disable clicking */
      opacity: 0.6; /* Slightly transparent */
    }

    .night-mode .route-card.disabled {
      background: rgba(100, 100, 100, 0.8); /* Adjusted gray for night mode */
      color: #999; /* Lighter gray text for night mode */
    }
  </style>
</head>
<body class="font-sans antialiased overflow-x-hidden">
<!-- Navbar -->
<nav class="navbar text-white p-6 sticky top-0 z-20">
  <div class="container mx-auto flex justify-between items-center max-w-7xl">
    <h1 class="text-4xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-indigo-600 bg-clip-text text-transparent">
      Path Recommendation System
    </h1>
  </div>
</nav>

<!-- Mode Toggle -->
<div class="mode-toggle" onclick="toggleMode()">☀️</div>

<!-- Main Content -->
<div class="content-wrapper">
  <!-- Controls (Left Side) -->
  <div class="controls-container">
    <div class="bg-white night-mode:bg-gray-800 rounded-3xl shadow-xl p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800 night-mode:text-gray-200 bg-gradient-to-r from-blue-400 to-indigo-600 bg-clip-text text-transparent">
        Rota Planlayıcı
      </h2>

      <!-- Passenger Info -->
      <div class="space-y-4">
        <div>
          <label class="block text-base font-semibold mb-1 text-gray-700 night-mode:text-gray-300">Yolcu Türü</label>
          <select id="passenger_type" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 text-sm" onchange="updatePassengerFields()">
            <option value="" disabled selected>Yolcu türünü seçin</option>
            <option value="general">Genel</option>
            <option value="student">Öğrenci</option>
            <option value="old">Yaşlı</option>
          </select>
        </div>

        <div>
          <input type="text" id="name_surname" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Ad Soyad">
        </div>

        <div id="student_field" class="dynamic-section">
          <input type="text" id="student_id" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Öğrenci ID">
        </div>

        <div id="old_field" class="dynamic-section">
          <input type="text" id="pass_card" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Geçiş Kartı">
        </div>

        <!-- Marker Buttons -->
        <div class="space-y-4">
          <div>
            <button class="marker-btn w-full text-white p-3 font-semibold text-base" onclick="toggleMarker('start')">
              <img src="/images/girispng.png" alt="Start Marker"> Başlangıç Noktası
            </button>
            <div id="start_section" class="dynamic-section mt-2 space-y-2">
              <input type="text" id="start_lat" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Başlangıç Enlem (Lat)">
              <input type="text" id="start_lon" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Başlangıç Boylam (Lon)">
            </div>
          </div>

          <div>
            <button class="marker-btn w-full text-white p-3 font-semibold text-base" onclick="toggleMarker('end')">
              <img src="/images/finish.png" alt="End Marker"> Bitiş Noktası
            </button>
            <div id="end_section" class="dynamic-section mt-2 space-y-2">
              <input type="text" id="end_lat" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Bitiş Enlem (Lat)">
              <input type="text" id="end_lon" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Bitiş Boylam (Lon)">
            </div>
          </div>
        </div>

        <!-- Payment Methods -->
        <div>
          <label class="block text-base font-semibold mb-1 text-gray-700 night-mode:text-gray-300">Ödeme Yöntemi</label>
          <select id="payment_method" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 text-sm" onchange="updatePaymentFields()">
            <option value="" disabled selected>Ödeme yöntemi seçin</option>
            <option value="card">Kredi Kartı</option>
            <option value="cash">Nakit</option>
            <option value="cityCard">Kentkart Ödeme</option>
          </select>

          <div id="card_field" class="dynamic-section mt-2 space-y-2">
            <input type="text" id="card_number" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Kart Numarası">
            <input type="text" id="card_limit" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Kart Limiti">
          </div>

          <div id="cash_field" class="dynamic-section mt-2">
            <input type="text" id="cash_amount" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Nakit Miktarı">
          </div>

          <div id="cityCard_field" class="dynamic-section mt-2 space-y-2">
            <input type="text" id="card_number2" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Kart Numarası">
            <input type="text" id="card_balance" class="input-field w-full p-2 focus:outline-none text-gray-700 night-mode:text-gray-200 placeholder-gray-400 night-mode:placeholder-gray-500 text-sm" placeholder="Kart Bakiyesi">
          </div>
        </div>

        <button onclick="drawRoute()" class="btn-draw w-full text-white p-3 font-semibold text-base mt-4">Yolu Çiz</button>

        <!-- Route Info -->
        <div id="routeInfo" class="space-y-4 mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Map (Right Side) -->
  <div id="map-container">
    <div id="map" class="relative"></div>
    <div id="coords" class="coords-display">Enlem: -, Boylam: -</div>
  </div>
</div>

<div id="overlay" class="overlay"></div>
<script th:inline="javascript">
  const nightModeStyles = [
    { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
    { elementType: 'labels.text.fill', stylers: [{ color: '#d4d4d8' }] },
    { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1e25' }] },
    { featureType: 'administrative', elementType: 'geometry', stylers: [{ color: '#757575' }] },
    { featureType: 'administrative.country', elementType: 'labels.text.fill', stylers: [{ color: '#9e9e9e' }] },
    { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#bdbdbd' }] },
    { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#211f1f' }, { lightness: 10 }] },
    { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#34495e' }] },
    { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#a0aec0' }] },
    { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1e2a38' }] },
    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#211f1f' }] },
    { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] },
    { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#a0aec0' }] },
    { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#4a627a' }] },
    { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2a44' }] },
    { featureType: 'road.arterial', elementType: 'geometry', stylers: [{ color: '#41556b' }] },
    { featureType: 'road.local', elementType: 'geometry', stylers: [{ color: '#3c4e66' }] },
    { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#34495e' }] },
    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#1a2632' }] },
    { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#8294a5' }] }
  ];

  const lightModeStyles = [
    {"featureType": "water", "elementType": "geometry", "stylers": [{"color": "#87ceeb"}, {"lightness": 10}]},
    {"featureType": "landscape", "elementType": "geometry", "stylers": [{"color": "#f0fff0"}, {"lightness": 15}]},
    {"featureType": "road", "elementType": "geometry", "stylers": [{"color": "#ffdead"}, {"lightness": 20}]}
  ];

  function toggleMode() {
    document.body.classList.toggle('night-mode');
    const toggle = document.querySelector('.mode-toggle');
    const isNightMode = document.body.classList.contains('night-mode');
    toggle.textContent = isNightMode ? '🌙' : '☀️';
    localStorage.setItem('mode', isNightMode ? 'night' : 'day');
    if (map) {
      map.setOptions({ styles: isNightMode ? nightModeStyles : lightModeStyles });
    }
  }

  function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    section.classList.toggle('show');
  }

  var stops = /*[[${stops}]]*/ [];
  var map;
  var currentPolyline = [];
  var infoWindow;
  var startMarker = null;
  var targetMarker = null;
  var allRoutesData = null;
  var requestDataGlobal = null;
  var routeDataStore = []; // Rotaları saklamak için global bir dizi

  function initMap() {
    const savedMode = localStorage.getItem('mode');
    if (savedMode === 'night') {
      document.body.classList.add('night-mode');
      document.querySelector('.mode-toggle').textContent = '🌙';
    } else {
      document.body.classList.remove('night-mode');
      document.querySelector('.mode-toggle').textContent = '☀️';
    }

    const isNightMode = document.body.classList.contains('night-mode');
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: {lat: 40.7669, lng: 29.9408},
      styles: isNightMode ? nightModeStyles : lightModeStyles
    });

    infoWindow = new google.maps.InfoWindow();

    stops.forEach(function(stop) {
      var iconUrl = stop.types === 'bus' ?
              'https://maps.google.com/mapfiles/kml/shapes/bus.png' :
              'https://maps.google.com/mapfiles/kml/shapes/rail.png';
      new google.maps.Marker({
        position: {lat: stop.lat, lng: stop.lon},
        map: map,
        title: stop.ids,
        icon: { url: iconUrl, scaledSize: new google.maps.Size(48, 48) }
      });
    });

    var coordDiv = document.getElementById('coords');
    map.addListener('mousemove', function(event) {
      var lat = event.latLng.lat().toFixed(6);
      var lng = event.latLng.lng().toFixed(6);
      coordDiv.textContent = 'Enlem: ' + lat + ', Boylam: ' + lng;
    });
  }

  function toggleMarker(type) {
    toggleSection(type + '_section');
    const latInput = document.getElementById(type + '_lat');
    const lonInput = document.getElementById(type + '_lon');
    const lat = parseFloat(latInput.value) || (type === 'start' ? 40.7669 : 40.7769);
    const lon = parseFloat(lonInput.value) || (type === 'start' ? 29.9408 : 29.9508);

    if (type === 'start') {
      if (!startMarker) {
        startMarker = new google.maps.Marker({
          position: {lat: lat, lng: lon},
          map: map,
          draggable: true,
          icon: { url: '/images/girispng.png', scaledSize: new google.maps.Size(48, 48) },
          title: 'Başlangıç Noktası'
        });

        startMarker.addListener('dragend', function(event) {
          const lat = event.latLng.lat().toFixed(6);
          const lng = event.latLng.lng().toFixed(6);
          document.getElementById('start_lat').value = lat;
          document.getElementById('start_lon').value = lng;
        });
      } else {
        startMarker.setMap(startMarker.getMap() ? null : map);
      }
    } else if (type === 'end') {
      if (!targetMarker) {
        targetMarker = new google.maps.Marker({
          position: {lat: lat, lng: lon},
          map: map,
          draggable: true,
          icon: { url: '/images/finish.png', scaledSize: new google.maps.Size(48, 48) },
          title: 'Hedef Noktası'
        });

        targetMarker.addListener('dragend', function(event) {
          const lat = event.latLng.lat().toFixed(6);
          const lng = event.latLng.lng().toFixed(6);
          document.getElementById('end_lat').value = lat;
          document.getElementById('end_lon').value = lng;
        });
      } else {
        targetMarker.setMap(targetMarker.getMap() ? null : map);
      }
    }

    latInput.addEventListener('input', updateMarkerPositions);
    lonInput.addEventListener('input', updateMarkerPositions);
  }

  function updateMarkerPositions() {
    const startLat = parseFloat(document.getElementById('start_lat').value);
    const startLon = parseFloat(document.getElementById('start_lon').value);
    const endLat = parseFloat(document.getElementById('end_lat').value);
    const endLon = parseFloat(document.getElementById('end_lon').value);

    if (startMarker && !isNaN(startLat) && !isNaN(startLon)) {
      startMarker.setPosition({lat: startLat, lng: startLon});
    }
    if (targetMarker && !isNaN(endLat) && !isNaN(endLon)) {
      targetMarker.setPosition({lat: endLat, lng: endLon});
    }
  }

  function updatePassengerFields() {
    document.getElementById('student_field').classList.remove('show');
    document.getElementById('old_field').classList.remove('show');

    const selectedType = document.getElementById('passenger_type').value;
    if (selectedType === 'student') {
      document.getElementById('student_field').classList.add('show');
    } else if (selectedType === 'old') {
      document.getElementById('old_field').classList.add('show');
    }
  }

  function updatePaymentFields() {
    document.getElementById('card_field').classList.remove('show');
    document.getElementById('cash_field').classList.remove('show');
    document.getElementById('cityCard_field').classList.remove('show');

    const selectedMethod = document.getElementById('payment_method').value;
    if (selectedMethod) {
      document.getElementById(selectedMethod + '_field').classList.add('show');
    }
  }

  function showErrorPopup(message) {
    let popup = document.querySelector('.popup');
    if (!popup) {
      popup = document.createElement('div');
      popup.classList.add('popup');
      document.body.appendChild(popup);
    }

    let overlay = document.querySelector('.overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.classList.add('overlay');
      document.body.appendChild(overlay);
    }

    popup.innerHTML = `
      <h3>Rota Bulunamadı</h3>
      <p>${message}</p>
      <button onclick="closePopup()">Tamam</button>
    `;

    popup.classList.add('show');
    overlay.classList.add('show');
  }

  function showRouteDetailsPopup(routeIndex, type) {
    const route = routeDataStore[routeIndex];
    if (!route) {
      showErrorPopup('Rota verisi bulunamadı.');
      return;
    }

    let popup = document.querySelector('.popup');
    if (!popup) {
      popup = document.createElement('div');
      popup.classList.add('popup');
      document.body.appendChild(popup);
    }

    let overlay = document.querySelector('.overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.classList.add('overlay');
      document.body.appendChild(overlay);
    }

    // Transport icon helper function
    function getTransportIcon(route) {
      const transportTypes = route.path.map(segment => Object.keys(segment)[0]);
      const uniqueTypes = [...new Set(transportTypes)];
      return uniqueTypes.map(type => {
        switch(type) {
          case 'walk': return '🚶';
          case 'bus': return '🚌';
          case 'tram': return '🚊';
          case 'taxi': return '🚕';
          default: return '🛣️';
        }
      }).join(' ');
    }

    // Detailed segment info with response data
    const detailedRouteInfo = route.path.map((segment, index) => {
      const transportType = Object.keys(segment)[0];
      const coords = segment[transportType];
      let transportIcon = '';
      switch(transportType) {
        case 'walk': transportIcon = '🚶'; break;
        case 'bus': transportIcon = '🚌'; break;
        case 'tram': transportIcon = '🚊'; break;
        case 'taxi': transportIcon = '🚕'; break;
        default: transportIcon = '🛣️';
      }
      return `
            <div class="route-card mb-2">
                <p><strong>${transportIcon} ${transportType.toUpperCase()} - Segment ${index + 1}</strong></p>
                <p><strong>Koordinatlar:</strong> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}</p>
                <p><strong>Ulaşım Türü:</strong> ${transportType}</p>
            </div>
        `;
    }).join('');

    // Pop-up içeriği
    popup.innerHTML = `
        <h3 class="text-lg font-semibold mb-2">${type.toUpperCase()} - Rota ${routeIndex + 1} ${getTransportIcon(route)}</h3>
        <div class="space-y-2">
            <p><strong>Mesafe:</strong> ${route.distance.toFixed(1)} km</p>
            <p><strong>Süre:</strong> ${route.time} dk</p>
            <p><strong>Tutar:</strong> ${route.amount.toFixed(1)} TL</p>
            <p><strong>En İyi:</strong> ${route.best_for}</p>
            <p><strong>Kalan Para:</strong> ${route.remainMoney.toFixed(1)} TL</p>
        </div>
        <h4 class="text-md font-semibold mt-4 mb-2">Rota Detayları</h4>
        <div class="max-h-60 overflow-y-auto">
            ${detailedRouteInfo}
        </div>
        <button onclick="closePopup()" class="btn-draw w-full text-white p-3 font-semibold text-base mt-4">Kapat</button>
    `;

    popup.classList.add('show');
    overlay.classList.add('show');
  }

  function closePopup() {
    const popup = document.querySelector('.popup');
    const overlay = document.querySelector('.overlay');

    if (popup) popup.classList.remove('show');
    if (overlay) overlay.classList.remove('show');
  }

  function drawRoute() {
    const start_lat = parseFloat(document.getElementById('start_lat').value);
    const start_lon = parseFloat(document.getElementById('start_lon').value);
    const end_lat = parseFloat(document.getElementById('end_lat').value);
    const end_lon = parseFloat(document.getElementById('end_lon').value);

    if (isNaN(start_lat) || isNaN(start_lon) || isNaN(end_lat) || isNaN(end_lon)) {
      alert('Lütfen tüm koordinat alanlarına geçerli sayılar girin.');
      return;
    }

    const passengerType = document.getElementById('passenger_type').value;
    const nameSurname = document.getElementById('name_surname').value;

    if (!passengerType || !nameSurname) {
      alert('Lütfen yolcu türünü seçin ve geçerli bir ad soyad girin.');
      return;
    }

    const paymentType = document.getElementById('payment_method').value;
    if (!paymentType) {
      alert('Lütfen bir ödeme yöntemi seçin.');
      return;
    }

    let passengers = { type: passengerType, nameSurname: nameSurname };
    if (passengerType === 'student') {
      passengers.student_id = document.getElementById('student_id').value || '';
    } else if (passengerType === 'old') {
      passengers.pass_card = document.getElementById('pass_card').value || '';
    }

    let payment_method;
    if (paymentType === 'card') {
      payment_method = {
        type: 'creditCard',
        limit: parseFloat(document.getElementById('card_limit').value) || 0,
        card_number: document.getElementById('card_number').value || ''
      };
    } else if (paymentType === 'cash') {
      payment_method = {
        type: 'cash',
        cash: parseFloat(document.getElementById('cash_amount').value) || 0
      };
    } else if (paymentType === 'cityCard') {
      payment_method = {
        type: 'cityCard',
        balance: parseFloat(document.getElementById('card_balance').value) || 0,
        card_number: document.getElementById('card_number2').value || ''
      };
    }

    const requestData = {
      start_location: { type: "current", lat: start_lat, lon: start_lon },
      target_location: { type: "target", lat: end_lat, lon: end_lon },
      passengers: passengers,
      payment_method: payment_method
    };

    fetch('/api/draw_route', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('API yanıtı başarısız: ' + response.statusText);
              }
              return response.json();
            })
            .then(data => {
              if (!data || Object.keys(data).length === 0) {
                throw new Error('Belirtilen koordinatlar arasında sizin bakiyenize uygun rota bulunamadı.');
              }
              allRoutesData = data;
              requestDataGlobal = requestData;
              showRouteInfo(data, requestData);
            })
            .catch(error => {
              if (currentPolyline.length > 0) {
                currentPolyline.forEach(poly => poly.setMap(null));
                currentPolyline = [];
              }
              document.getElementById('routeInfo').innerHTML = '';
              showErrorPopup(error.message || 'Rota çizilirken bir hata oluştu.');
            });
  }

  function determineRouteColor(route) {
    if (!route || !route.path) return '#8B5CF6'; // Varsayılan renk
    const transportTypes = route.path.map(segment => Object.keys(segment)[0]);
    const uniqueTypes = [...new Set(transportTypes)];

    if (uniqueTypes.length === 1 && uniqueTypes[0] === 'taxi') {
      return '#F59E0B';
    } else if (transportTypes.includes('walk')) {
      return '#3B82F6';
    } else if (uniqueTypes.length === 1 && (uniqueTypes[0] === 'bus' || uniqueTypes[0] === 'tram')) {
      return '#10B981';
    } else {
      return '#8B5CF6';
    }
  }
  function drawPathOnMap(routeIndex) {
    const route = routeDataStore[routeIndex];
    if (!route) {
      console.error('Rota verisi bulunamadı:', routeIndex);
      showErrorPopup('Rota verisi bulunamadı.');
      return;
    }

    if (!map) {
      console.error('Map is not initialized yet.');
      showErrorPopup('Harita yüklenemedi, lütfen sayfayı yenileyin.');
      return;
    }

    // Önceki çizimi temizle
    if (currentPolyline.length > 0) {
      currentPolyline.forEach(poly => poly.setMap(null));
      currentPolyline = [];
    }

    if (!route.path || !Array.isArray(route.path) || route.path.length < 2) {
      console.error('Geçersiz veya yetersiz yol verisi:', route.path);
      showErrorPopup('Rota çizimi için yeterli veri yok.');
      return;
    }

    const pathCoordinates = route.path.map(segment => {
      const type = Object.keys(segment)[0];
      const coords = segment[type];
      if (!coords || coords.length !== 2) {
        console.error('Geçersiz koordinatlar:', segment);
        return null;
      }
      return { lat: coords[0], lng: coords[1], type: type }; // Tür bilgisini ekle
    }).filter(coord => coord !== null);

    if (pathCoordinates.length < 2) {
      console.error('Yeterli koordinat bulunamadı:', pathCoordinates);
      showErrorPopup('Rota çizimi için yeterli koordinat yok.');
      return;
    }

    for (let i = 0; i < pathCoordinates.length - 1; i++) {
      const segmentPath = [
        pathCoordinates[i],
        pathCoordinates[i + 1]
      ];

      const startType = pathCoordinates[i].type; // Başlangıç noktası türü
      const endType = pathCoordinates[i + 1].type; // Bitiş noktası türü
      const segmentType = Object.keys(route.path[i])[0]; // Segmentin kendi türü

      // Renk ve transfer durumunu belirle
      let strokeColor;
      let isTransfer = false;

      // Başlangıç veya bitişte "walk" veya "taxi" varsa doğrudan renk ataması
      if (i === 0 || i === pathCoordinates.length - 2) { // Başlangıç veya son segment
        if (startType === 'walk' || endType === 'walk') {
          strokeColor = '#EF4444'; // Kırmızı (walk için)
        } else if (startType === 'taxi' || endType === 'taxi') {
          strokeColor = '#F59E0B'; // Sarı (taxi için)
        } else {
          // "Walk" ve "taxi" değilse, normal kurallar uygulanır
          if (segmentType === 'walk') {
            strokeColor = '#EF4444'; // Kırmızı (walk için)
          } else if (segmentType === 'taxi') {
            strokeColor = '#F59E0B'; // Sarı (taxi için)
          } else if (segmentType === 'bus' || segmentType === 'tram') {
            // "Bus" veya "tram" için transfer kontrolü
            if (startType !== endType) {
              isTransfer = true; // Farklı türler arasında geçiş varsa transfer
              strokeColor = '#FFC0CB'; // Turuncu (transfer için)
            } else {
              strokeColor = '#10B981'; // Yeşil (sadece bus veya tram için)
            }
          } else {
            strokeColor = '#8B5CF6'; // Varsayılan renk
          }
        }
      } else {
        // Orta segmentler için normal kurallar
        if (segmentType === 'walk') {
          strokeColor = '#EF4444'; // Kırmızı (walk için)
        } else if (segmentType === 'taxi') {
          strokeColor = '#F59E0B'; // Sarı (taxi için)
        } else if (segmentType === 'bus' || segmentType === 'tram') {
          // "Bus" veya "tram" için transfer kontrolü
          if (startType !== endType) {
            isTransfer = true; // Farklı türler arasında geçiş varsa transfer
            strokeColor = '#FFC0CB'; // Turuncu (transfer için)
          } else {
            strokeColor = '#10B981'; // Yeşil (sadece bus veya tram için)
          }
        } else {
          strokeColor = '#8B5CF6'; // Varsayılan renk
        }
      }

      const segmentPolyline = new google.maps.Polyline({
        path: segmentPath,
        geodesic: true,
        strokeColor: strokeColor,
        strokeOpacity: 1.0,
        strokeWeight: 4,
        map: map
      });

      currentPolyline.push(segmentPolyline);

      const startCoords = route.path[i][startType];
      const endCoords = route.path[i + 1][endType];

      // Info window içeriği
      let infoContent = `
        <div style="font-family: 'Poppins', sans-serif; color: #333; padding: 5px;">
            <h4 style="font-weight: 600; margin-bottom: 5px; color: ${strokeColor};">Segment ${i + 1}</h4>
            <p><strong>Segment Türü:</strong> ${segmentType}</p>
            <p><strong>Başlangıç Türü:</strong> ${startType}</p>
            <p><strong>Bitiş Türü:</strong> ${endType}</p>
      `;

      // Transfer durumu varsa ekle
      if (isTransfer) {
        infoContent += '<p><strong>Durum:</strong> Transfer</p>';
      }

      infoContent += `
            <p><strong>Başlangıç:</strong> ${startCoords[0].toFixed(6)}, ${startCoords[1].toFixed(6)}</p>
            <p><strong>Bitiş:</strong> ${endCoords[0].toFixed(6)}, ${endCoords[1].toFixed(6)}</p>
        </div>
      `;

      const infoWindow = new google.maps.InfoWindow({
        content: infoContent
      });

      google.maps.event.addListener(segmentPolyline, 'mouseover', function(event) {
        infoWindow.setPosition(event.latLng);
        infoWindow.open(map);
      });

      google.maps.event.addListener(segmentPolyline, 'mouseout', function() {
        infoWindow.close();
      });
    }

    const bounds = new google.maps.LatLngBounds();
    pathCoordinates.forEach(coord => {
      bounds.extend(new google.maps.LatLng(coord.lat, coord.lng));
    });
    map.fitBounds(bounds);
  }

  function drawPathAndShowDetails(routeIndex, type) {
    console.log('Drawing route for index:', routeIndex, 'Type:', type);
    drawPathOnMap(routeIndex);
    showRouteDetailsPopup(routeIndex, type);
  }

  function showRouteInfo(data, requestData) {
    const passengerType = requestData.passengers.type;
    const nameSurname = requestData.passengers.nameSurname;
    const paymentType = requestData.payment_method.type;
    const paymentMethod = requestData.payment_method;

    // Get the user's entered payment amount
    let availableAmount;
    if (paymentType === 'creditCard') {
      availableAmount = paymentMethod.limit;
    } else if (paymentType === 'cash') {
      availableAmount = paymentMethod.cash;
    } else if (paymentType === 'cityCard') {
      availableAmount = paymentMethod.balance;
    }

    let passengerDisplay = `
    <div class="route-card">
      <p><strong>Ad Soyad:</strong> ${nameSurname}</p>
      <p><strong>Başlangıç:</strong> ${requestData.start_location.lat.toFixed(6)}, ${requestData.start_location.lon.toFixed(6)}</p>
      <p><strong>Hedef:</strong> ${requestData.target_location.lat.toFixed(6)}, ${requestData.target_location.lon.toFixed(6)}</p>
      ${passengerType === 'student' ? `<p><strong>Öğrenci ID:</strong> ${requestData.passengers.student_id || '-'}</p>` : ''}
      ${passengerType === 'old' ? `<p><strong>Geçiş Kartı:</strong> ${requestData.passengers.pass_card || '-'}</p>` : ''}
    </div>
  `;

    let paymentDisplay = '';
    if (paymentType === 'creditCard') {
      paymentDisplay = `
      <div class="route-card">
        <p><strong>Ödeme:</strong> Kredi Kartı</p>
        <p><strong>Kart No:</strong> ${paymentMethod.card_number || '-'}</p>
        <p><strong>Limit:</strong> ${paymentMethod.limit.toFixed(1)} TL</p>
      </div>
    `;
    } else if (paymentType === 'cash') {
      paymentDisplay = `
      <div class="route-card">
        <p><strong>Ödeme:</strong> Nakit</p>
        <p><strong>Miktar:</strong> ${paymentMethod.cash.toFixed(1)} TL</p>
      </div>
    `;
    } else if (paymentType === 'cityCard') {
      paymentDisplay = `
      <div class="route-card">
        <p><strong>Ödeme:</strong> Kentkart</p>
        <p><strong>Kart No:</strong> ${paymentMethod.card_number || '-'}</p>
        <p><strong>Bakiye:</strong> ${paymentMethod.balance.toFixed(1)} TL</p>
      </div>
    `;
    }

    routeDataStore = []; // Rota verilerini sıfırla
    let routesHtml = '';
    let globalRouteIndex = 0;

    Object.keys(data).forEach((type, typeIndex) => {
      const routes = data[type];
      routesHtml += `
      <div class="transport-type" onclick="toggleRoutes(${typeIndex})">
        <p>${type.charAt(0).toUpperCase() + type.slice(1)}</p>
      </div>
      <div id="routes-${typeIndex}" class="route-list">
        ${routes.map((route, routeIndex) => {
        routeDataStore[globalRouteIndex] = route; // Rota verisini global diziye ekle
        const currentIndex = globalRouteIndex;
        globalRouteIndex++;
        // Check if route amount exceeds available payment
        const isDisabled = route.amount > availableAmount ? 'disabled' : '';
        return `
            <div class="route-card ${isDisabled}" onclick="${isDisabled ? '' : `drawPathAndShowDetails(${currentIndex}, '${type}')`}">
              <p><strong>Rota ${routeIndex + 1}</strong></p>
              <p><strong>Mesafe:</strong> ${route.distance.toFixed(1)} km</p>
              <p><strong>Süre:</strong> ${route.time} dk</p>
              <p><strong>Tutar:</strong> ${route.amount.toFixed(1)} TL</p>
              <p><strong>En İyi:</strong> ${route.best_for}</p>
            </div>
          `;
      }).join('')}
      </div>
    `;
    });

    document.getElementById('routeInfo').innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-center">Rota Bilgileri</h2>
    ${passengerDisplay}
    ${paymentDisplay}
    <h4 class="mt-4 font-semibold text-center text-xl">Rotalar</h4>
    ${routesHtml}
  `;

    document.getElementById('routeInfo').scrollIntoView({ behavior: 'smooth' });

    if (routeDataStore.length > 0) {
      const firstType = Object.keys(data)[0];
      // Only draw the first route if it's affordable
      if (routeDataStore[0].amount <= availableAmount) {
        drawPathAndShowDetails(0, firstType);
      }
    }
  }

  function toggleRoutes(typeIndex) {
    const routeList = document.getElementById(`routes-${typeIndex}`);
    const isShown = routeList.classList.contains('show');

    document.querySelectorAll('.route-list').forEach(list => {
      list.classList.remove('show');
    });

    if (!isShown) {
      routeList.classList.add('show');
    }
  }
</script>
<script th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${api_key} + '&callback=initMap'}" async defer></script>
</body>
</html>